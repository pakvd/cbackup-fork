# 📊 Схемы архитектуры cBackup

## 🔷 Логическая схема приложения

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
│                      (Браузер, HTTP)                             │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              │ HTTP/HTTPS (порт 8080/443)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         NGINX                                    │
│                   (Веб-сервер / Reverse Proxy)                   │
│                   - Статические файлы                            │
│                   - Проксирование PHP запросов                   │
└────────────────────────────┬────────────────────────────────────┘
                              │
                              │ FastCGI (порт 9000)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    WEB (PHP-FPM)                                 │
│              Yii2 Framework Application                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Контроллеры:                                              │  │
│  │ - ConfigController (настройки)                             │  │
│  │ - NodeController (устройства)                             │  │
│  │ - TaskController (задачи)                                  │  │
│  │ - ScheduleController (расписание)                        │  │
│  │ - API v1/v2 (REST API)                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Компоненты:                                                │  │
│  │ - NetSsh (SSH подключение к Worker)                         │  │
│  │ - Service (управление сервисами)                            │  │
│  │ - Telnet (Telnet протокол)                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────┬───────────────────┬─────────────────┬─────────────────┘
         │                   │                 │
         │ MySQL (3306)      │ Redis (6379)    │ HTTP API
         │                   │                 │ (внутренняя сеть)
         ▼                   ▼                 ▼
┌──────────────────┐  ┌─────────────┐  ┌──────────────────────────┐
│   MySQL (DB)     │  │   REDIS     │  │    WORKER (Java)         │
│                  │  │   (Cache)   │  │  Spring Boot Application │
│ - Конфигурация   │  │             │  │                          │
│ - Узлы           │  │ - Кеш БД    │  │ ┌──────────────────────┐│
│ - Задачи         │  │ - Сессии    │  │ │ Scheduler             ││
│ - Расписание     │  │ - Очереди   │  │ │ - Планировщик задач   ││
│ - Логи           │  │             │  │ │ - CRON задачи         ││
│ - Учетные данные │  │             │  │ └──────────────────────┘│
│                  │  │             │  │ ┌──────────────────────┐│
│                  │  │             │  │ │ Workers               ││
│                  │  │             │  │ │ - SSH Worker          ││
│                  │  │             │  │ │ - Telnet Worker       ││
│                  │  │             │  │ │ - SNMP Worker         ││
│                  │  │             │  │ └──────────────────────┘│
│                  │  │             │  │ ┌──────────────────────┐│
│                  │  │             │  │ │ API Client           ││
│                  │  │             │  │ │ - GET/POST запросы   ││
│                  │  │             │  │ │ к Web API            ││
│                  │  │             │  │ └──────────────────────┘│
│                  │  │             │  └──────────────────────────┘
└──────────────────┘  └─────────────┘              │
                                                     │
                                                     │ SSH Shell
                                                     │ (порт 8437)
                                                     │ (опционально)
                                                     ▼
                                            ┌─────────────────┐
                                            │ SSH Shell       │
                                            │ (для управления)│
                                            │ (отключен по    │
                                            │  умолчанию)     │
                                            └─────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    ОБЩИЙ VOLUME                                 │
│              core/bin (application.properties)                  │
│              - Синхронизация конфигурации между                 │
│                Web и Worker                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🌐 Сетевая схема (Docker Network)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Docker Host                                     │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │              Docker Bridge Network                               │  │
│  │                  (cbackup_network)                               │  │
│  │                                                                   │  │
│  │  ┌─────────────┐      ┌──────────────┐      ┌──────────────┐    │  │
│  │  │   NGINX     │      │     WEB     │      │   WORKER    │    │  │
│  │  │  Container  │      │  Container  │      │  Container   │    │  │
│  │  │             │      │             │      │             │    │  │
│  │  │ Port: 80     │◄────►│ Port: 9000  │      │ Port: N/A   │    │  │
│  │  │             │FCGI  │             │      │             │    │  │
│  │  │             │      │             │      │             │    │  │
│  │  │ Exposed:    │      │             │      │             │    │  │
│  │  │ 8080:80     │      │             │      │             │    │  │
│  │  │ 443:443     │      │             │      │             │    │  │
│  │  └─────┬───────┘      └──────┬─────┘      └──────┬─────┘    │  │
│  │        │                      │                    │           │  │
│  │        │                      │                    │           │  │
│  │        │                      │ HTTP API          │           │  │
│  │        │                      │ (GET/POST)        │           │  │
│  │        │                      │◄──────────────────┘           │  │
│  │        │                      │                                │  │
│  │        │                      │ MySQL (3306)                   │  │
│  │        │                      ├─────────────────┐              │  │
│  │        │                      │                 │              │  │
│  │        │                      │                 │              │  │
│  │        │                      │ Redis (6379)    │              │  │
│  │        │                      ├─────────────────┐              │  │
│  │        │                      │                 │              │  │
│  │        │                      │                 ▼              │  │
│  │        │                      │         ┌──────────────┐      │  │
│  │        │                      │         │     DB       │      │  │
│  │        │                      │         │  Container   │      │  │
│  │        │                      │         │              │      │  │
│  │        │                      │         │ Port: 3306   │      │  │
│  │        │                      │         │              │      │  │
│  │        │                      │         └──────────────┘      │  │
│  │        │                      │                 ▲             │  │
│  │        │                      │                 │              │  │
│  │        │                      │                 │ MySQL (3306) │  │
│  │        │                      │                 │              │  │
│  │        │                      │                 │              │  │
│  │        │                      │                 │              │  │
│  │        │                      └─────────────────┘              │  │
│  │        │                                                        │  │
│  │        │                        ┌──────────────┐              │  │
│  │        │                        │    REDIS     │              │  │
│  │        │                        │  Container   │              │  │
│  │        │                        │              │              │  │
│  │        │                        │ Port: 6379   │              │  │
│  │        │                        │              │              │  │
│  │        │                        └──────────────┘              │  │
│  │        │                                                       │  │
│  │        │                    Shared Volume                     │  │
│  │        │         ┌──────────────────────────────────┐         │  │
│  │        │         │     core/bin/                   │         │  │
│  │        │         │  application.properties          │         │  │
│  │        │         │  (Shared между Web и Worker)    │         │  │
│  │        │         └──────────────────────────────────┘         │  │
│  │        │                                                       │  │
│  │  └──────────────────────────────────────────────────────────┘  │
│  │                                                                  │
│  └──────────────────────────────────────────────────────────────────┘
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    Внешние подключения                           │  │
│  │                                                                   │  │
│  │  Интернет                                                        │  │
│  │      │                                                           │  │
│  │      │ HTTP (порт 8080)                                          │  │
│  │      │ HTTPS (порт 443)                                          │  │
│  │      ▼                                                           │  │
│  │  ┌──────────┐                                                   │  │
│  │  │  NGINX   │                                                   │  │
│  │  │ :8080    │                                                   │  │
│  │  └──────────┘                                                   │  │
│  │                                                                   │  │
│  │  Сетевое оборудование (для бэкапов)                              │  │
│  │      │                                                            │  │
│  │      │ SSH / Telnet / SNMP                                       │  │
│  │      ▼                                                            │  │
│  │  ┌──────────┐                                                    │  │
│  │  │ WORKER   │                                                    │  │
│  │  │ (Java)   │                                                    │  │
│  │  └──────────┘                                                    │  │
│  │                                                                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

## 📋 Детализация портов и протоколов

### Порты, открытые наружу (Host)
- **8080** - HTTP (NGINX)
- **443** - HTTPS (NGINX, если настроен)

### Внутренние порты (Docker Network)
- **80** - NGINX (внутренний)
- **9000** - PHP-FPM (Web → NGINX)
- **3306** - MySQL (DB → Web, DB → Worker)
- **6379** - Redis (Redis → Web)
- **8437** - SSH Shell (Worker, опционально, отключен по умолчанию)

### Протоколы взаимодействия

1. **Пользователь ↔ NGINX**
   - Протокол: HTTP/HTTPS
   - Порт: 8080 (HTTP), 443 (HTTPS)

2. **NGINX ↔ Web (PHP-FPM)**
   - Протокол: FastCGI
   - Порт: 9000
   - Назначение: Обработка PHP запросов

3. **Web ↔ DB (MySQL)**
   - Протокол: MySQL
   - Порт: 3306
   - Назначение: Хранение данных, конфигурация

4. **Web ↔ Redis**
   - Протокол: Redis Protocol
   - Порт: 6379
   - Назначение: Кеширование, сессии

5. **Worker ↔ DB (MySQL)**
   - Протокол: MySQL (JDBC)
   - Порт: 3306
   - Назначение: Чтение задач, запись результатов

6. **Worker ↔ Web (API)**
   - Протокол: HTTP (REST API)
   - URL: `http://web/index.php`
   - Endpoints:
     - `v1/core/get-config` - Получение конфигурации
     - `v1/core/get-tasks` - Получение списка задач
     - `v1/core/set-task-result` - Сохранение результатов
     - `v2/core/*` - API v2 endpoints

7. **Web ↔ Worker (SSH Shell)**
   - Протокол: SSH2
   - Порт: 8437 (настраивается в application.properties)
   - Статус: Отключен по умолчанию
   - Назначение: Удаленное управление Worker через SSH

## 🔄 Потоки данных

### 1. Запрос пользователя
```
Пользователь → NGINX:8080 → Web:9000 (PHP-FPM) → MySQL:3306
                                              → Redis:6379
```

### 2. Выполнение задачи бэкапа
```
Scheduler (Worker) → MySQL:3306 (получение задачи)
                  → Web API (HTTP) → Получение конфигурации
                  → Сетевое оборудование (SSH/Telnet/SNMP)
                  → MySQL:3306 (сохранение результата)
                  → Web API (HTTP) → Отправка логов
```

### 3. Кеширование
```
Web → Redis:6379 (запись)
    ← Redis:6379 (чтение)
```

## 🗂 Структура данных

### База данных (MySQL)
- **config** - Системные настройки
- **nodes** - Узлы сети
- **tasks** - Задачи бэкапа
- **schedules** - Расписание выполнения
- **logs** - Логи выполнения
- **credentials** - Учетные данные для устройств
- **users** - Пользователи системы

### Кеш (Redis)
- Схема БД (schema cache)
- Конфигурация приложения
- Сессии пользователей
- Временные данные

### Общие файлы
- **core/bin/application.properties** - Конфигурация Worker
  - Синхронизируется между Web и Worker
  - Содержит SSH credentials для Worker shell
  - Настройки подключения к Web API

## 🔐 Безопасность

1. **Сетевая изоляция**
   - Все сервисы в одной Docker network (`cbackup_network`)
   - MySQL и Redis не доступны извне (только внутри сети)
   - Только NGINX принимает внешние запросы

2. **Порты**
   - MySQL порт не проброшен наружу
   - Redis порт не проброшен наружу
   - SSH Shell Worker отключен по умолчанию

3. **Аутентификация**
   - API Worker использует токен (`cbackup.token`)
   - Пользователи аутентифицируются через Web UI
   - Redis может иметь пароль (опционально)

## 📊 Диаграмма последовательности (Выполнение задачи)

```
User           NGINX        Web          Worker        DB         Device
 │              │            │             │             │           │
 │ HTTP Request │            │             │             │           │
 ├─────────────►│            │             │             │           │
 │              │ FastCGI    │             │             │           │
 │              ├───────────►│             │             │           │
 │              │            │ MySQL Query │             │           │
 │              │            ├─────────────►             │           │
 │              │            │◄─────────────┤             │           │
 │              │            │             │             │           │
 │              │◄───────────┤             │             │           │
 │◄─────────────┤            │             │             │           │
 │              │            │             │             │           │
 │              │            │   Cron      │             │           │
 │              │            │   Trigger   │             │           │
 │              │            ├───────────────────────────►           │
 │              │            │             │ Get Task    │           │
 │              │            │             ├─────────────►           │
 │              │            │             │◄─────────────┤           │
 │              │            │             │             │           │
 │              │            │   API Call  │             │           │
 │              │            │◄─────────────┤             │           │
 │              │            │             │             │           │
 │              │            │             │   Connect   │           │
 │              │            │             ├─────────────────────────►
 │              │            │             │   Backup   │           │
 │              │            │             │◄─────────────────────────┤
 │              │            │             │             │           │
 │              │            │             │ Save Result │           │
 │              │            │             ├─────────────►           │
 │              │            │             │             │           │
 │              │            │   API Call  │             │           │
 │              │            │◄─────────────┤             │           │
 │              │            │             │             │           │
```

## 📝 Легенда

- **→** - Направление запроса/данных
- **─** - Сетевое соединение
- **─┐** / **└─** - Разветвление соединений
- **◄─►** - Двустороннее взаимодействие
- **Container** - Docker контейнер
- **Network** - Docker сеть
- **Volume** - Общий том данных

