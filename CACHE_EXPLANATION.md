# üì¶ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è: Opcache vs Redis

## üîÑ Opcache + Redis = –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Opcache?

**Opcache** –∫—ç—à–∏—Ä—É–µ—Ç **PHP –±–∞–π—Ç–∫–æ–¥** (—Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥):

```
–ò—Å—Ö–æ–¥–Ω—ã–π PHP –∫–æ–¥ ‚Üí –ö–æ–º–ø–∏–ª—è—Ü–∏—è ‚Üí –ë–∞–π—Ç–∫–æ–¥ ‚Üí –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                      ‚Üë
                 Opcache –∫—ç—à–∏—Ä—É–µ—Ç –∑–¥–µ—Å—å
```

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**
```php
// –ë–µ–∑ Opcache: –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç —ç—Ç–æ—Ç –∫–æ–¥ –∑–∞–Ω–æ–≤–æ
$result = Yii::$app->db->createCommand('SELECT * FROM user')->queryAll();

// –° Opcache: PHP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–∞–π—Ç–∫–æ–¥ (–±—ã—Å—Ç—Ä–µ–µ –≤ 2-5 —Ä–∞–∑)
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç Redis?

**Redis** –∫—ç—à–∏—Ä—É–µ—Ç **–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**:

```
PHP –∫–æ–¥ ‚Üí –ó–∞–ø—Ä–æ—Å –∫ –ë–î ‚Üí –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –ö—ç—à –≤ Redis
                          ‚Üë
                    Redis —Ö—Ä–∞–Ω–∏—Ç –∑–¥–µ—Å—å
```

**–ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã:**
```php
// –ë–µ–∑ Redis: –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –≤ –ë–î
$users = User::find()->all(); // SQL –∑–∞–ø—Ä–æ—Å –∫–∞–∂–¥—ã–π —Ä–∞–∑

// –° Redis: –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –≤ –ë–î, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑ –∫—ç—à–∞
$users = Yii::$app->cache->getOrSet('all_users', function() {
    return User::find()->all(); // SQL —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π —Ä–∞–∑
}, 3600);
```

## üéØ –í –≤–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### Opcache –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
1. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –∫–æ–¥–∞ Yii2 framework
2. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö PHP –∫–ª–∞—Å—Å–æ–≤ (`vendor/`, `app/`)
3. ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ PHP –∑–∞–ø—Ä–æ—Å–∞

### Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
1. ‚úÖ Schema cache (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î) - `Yii::$app->db->enableSchemaCache`
2. ‚úÖ RBAC cache (–ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞) - `authManager->cache`
3. ‚úÖ –î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü - `help_about_phpinfo`, `help_about_permissions`
4. ‚úÖ –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë–µ–∑ Opcache –∏ Redis:
```
–ó–∞–ø—Ä–æ—Å ‚Üí –ö–æ–º–ø–∏–ª—è—Ü–∏—è PHP (50ms) ‚Üí SQL –∑–∞–ø—Ä–æ—Å (20ms) ‚Üí –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (30ms) = 100ms
```

### –° Opcache –∏ Redis:
```
–ó–∞–ø—Ä–æ—Å ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PHP (5ms) ‚Üí –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à Redis (1ms) ‚Üí –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (30ms) = 36ms
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç: –ø–æ—á—Ç–∏ –≤ 3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!**

## ‚úÖ –í—ã–≤–æ–¥

**–û–±–∞ –∫—ç—à–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´ –≤ production:**

| –ö—ç—à | –ß—Ç–æ –∫—ç—à–∏—Ä—É–µ—Ç | –£—Å–∫–æ—Ä—è–µ—Ç | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
|-----|-------------|----------|-------------------|
| **Opcache** | PHP –±–∞–π—Ç–∫–æ–¥ | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ | –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å |
| **Redis** | –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î | –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

```yaml
# docker-compose.yml
environment:
  ENABLE_OPCACHE: "true"  # ‚úÖ –í–ö–õ–Æ–ß–ò–¢–¨ - —É—Å–∫–æ—Ä—è–µ—Ç PHP –∫–æ–¥
  REDIS_HOST: "redis"    # ‚úÖ –í–ö–õ–Æ–ß–ò–¢–¨ - –∫—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
```

### –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å Opcache:
- ‚ùå PHP –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–º–µ–¥–ª–µ–Ω–Ω–µ–µ –≤ 2-5 —Ä–∞–∑)
- ‚ùå –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU
- ‚ùå Redis –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –æ–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö—É–∂–µ

### –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å Redis:
- ‚ùå –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –≤ –ë–î (–º–µ–¥–ª–µ–Ω–Ω–µ–µ –≤ 5-10 —Ä–∞–∑)
- ‚ùå –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ MySQL
- ‚ùå Opcache –≤—Å—ë —Ä–∞–≤–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è

## üöÄ –ò—Ç–æ–≥

**–û–±–∞ –≤–∫–ª—é—á–µ–Ω—ã = –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

```
Opcache —É—Å–∫–æ—Ä—è–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ PHP –∫–æ–¥–∞
       +
Redis —É—Å–∫–æ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º
       =
–ë—ã—Å—Ç—Ä–æ–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

