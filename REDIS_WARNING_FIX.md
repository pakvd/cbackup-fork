# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è Redis –æ memory overcommit

## ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:
```
WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition.
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ 1: Docker Compose (–ø—Ä–∏–º–µ–Ω–µ–Ω–æ)

–î–æ–±–∞–≤–ª–µ–Ω `sysctls` –≤ `docker-compose.yml`:
```yaml
sysctls:
  - vm.overcommit_memory=1
```

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:**
```bash
docker compose restart redis
docker compose logs redis
```

–ï—Å–ª–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏—Å—á–µ–∑–ª–æ - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ

## üîß –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–µ—Å–ª–∏ sysctls –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç):

### –†–µ—à–µ–Ω–∏–µ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Ö–æ—Å—Ç–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–µ (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω Docker):
```bash
# –í—Ä–µ–º–µ–Ω–Ω–æ (–¥–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
sudo sysctl vm.overcommit_memory=1

# –ü–æ—Å—Ç–æ—è–Ω–Ω–æ (–ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
echo "vm.overcommit_memory = 1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### –†–µ—à–µ–Ω–∏–µ 3: Privileged mode (–º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ)

–ï—Å–ª–∏ `sysctls` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ö–æ—Å—Ç—É, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å privileged mode:

```yaml
redis:
  # ...
  privileged: true
  sysctls:
    - vm.overcommit_memory=1
```

**‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ:** Privileged mode –¥–∞—ë—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∞ - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

### –†–µ—à–µ–Ω–∏–µ 4: –û—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å appendonly –≤ Redis:

```yaml
command: >
  sh -c "
  if [ -n \"$$REDIS_PASSWORD\" ]; then
    redis-server --requirepass \"$$REDIS_PASSWORD\" --maxmemory 256mb --maxmemory-policy allkeys-lru
  else
    redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
  fi
  "
```

**‚ö†Ô∏è –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –≠—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö Redis.

## ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:

1. **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞** `sysctls` (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ docker-compose.yml)
2. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –Ω–∞ —Ö–æ—Å—Ç–µ (–†–µ—à–µ–Ω–∏–µ 2) - —ç—Ç–æ —Å–∞–º–æ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ
3. –¢–æ–ª—å–∫–æ –≤ –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ privileged mode

## üìù –ü—Ä–æ–≤–µ—Ä–∫–∞:

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```bash
docker compose restart redis
docker compose logs redis | grep -i warning
```

–ï—Å–ª–∏ warning –∏—Å—á–µ–∑ - –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞! ‚úÖ

